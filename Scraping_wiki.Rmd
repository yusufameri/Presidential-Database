---
title: "Scraping Data"
author: "Yusuf Ameri"
date: "December 3, 2016"
output: html_document
---

### Load Neccessary Libraries
```{r libraries, error=FALSE, warning=FALSE,message=FALSE,results='hide'}
library(rvest)    # for web scraping
library(dplyr)    # for column selection
library(tidyr)    # for column tidying
library(magrittr) # for piping
library(tibble)   # for pretty table printing
library(readr)    # for converting column types
```


### Scrape url from Wiki
We need to scrap an html table from wiki that has info on presidential elections and popular votes. This table only has popular vote data from 1824. Click [Here](https://en.wikipedia.org/wiki/List_of_United_States_presidential_elections_by_popular_vote_margin#List) To see the wiki yourself.
```{r main}
# URL of wiki of list of presidents
url <- "https://en.wikipedia.org/wiki/List_of_United_States_presidential_elections_by_popular_vote_margin"

# read URL
president_list <- read_html(url)

# Scrape following the xpath for the table
president_table <- president_list %>% html_node(xpath = '//*[@id="mw-content-text"]/table[2]') %>% html_table()

# display first 2 rows and first 4 attributes
head(president_table[1:2,1:4])
```

As you can see above, the data table is not yet clean and has some work to do, we will first remove the first two rows which are simply headers and an empty line.
```{r clean1}
# remove the first 2 rows which are headers
president_table <- president_table[3:nrow(president_table),]

# display first 2 rows and first 4 attributes
head(president_table[1:2,1:4])
```

Next, we will rename the columns so that they make sense.
```{r rename_columns}
# rename columns
colnames(president_table)[1] <- "Election_Number"
colnames(president_table)[2] <- "Election_Year"
colnames(president_table)[3] <- "Winner"
colnames(president_table)[4] <- "W_Party"
colnames(president_table)[5] <- "Electoral_Proportion"
colnames(president_table)[6] <- "Electoral_Percentage"
colnames(president_table)[7] <- "Popular_Percentage"
colnames(president_table)[8] <- "Popular_Margin"
colnames(president_table)[9] <- "Winner_Votes"
colnames(president_table)[10] <- "Winner_Votes_Margin"
colnames(president_table)[11] <- "Runner-Up"
colnames(president_table)[12] <- "L_Party"
colnames(president_table)[13] <- "Turnout_pct"

# store president_table as a tibble for better printing
president_table <- tbl_df(president_table)

# display president table with new column names
head(president_table)
```
Things are starting to look much better. We still need to change the the datatypes of many of this columns and extract more useful attributes given what we have (for example, number of votes for losing opponent)

```{r pres_str}
# lets have a look at the datatypes in each columns
str(president_table)
```

We need to convert Some of these column types to the right datatype
```{r convert_cols}
# convert column types
president_table <- president_table %>% readr::type_convert(col_types = cols(
  Election_Number = col_integer(),
  W_Party = col_factor(levels(president_table$W_Party %>% as.factor())),
  Winner = col_factor(levels(president_table$Winner %>% as.factor())),
  `Runner-Up` = col_factor(levels(president_table$`Runner-Up` %>% as.factor())),
  L_Party = col_factor(levels(president_table$L_Party %>% as.factor()))
))
```

For columns with string representations of integers and percentage points, we have to strip unneccesary characters such as the percent '%' sign and division sign '/'.
Here are some examples
```{r examples}
# need to get rid of / sign
president_table$Electoral_Proportion[1]

# need to get rid of % sign
president_table$Turnout_pct[1]
```

In the process of getting rid of the 'Electoral_Proportion' Column, we will create new columns for Electoral votes won by the winning candidate and total electoral votes in the election year. It will be up to the user to query what percentage the electoral vote the winner recieved (**for now**).

```{r new_columns}
# replace electoral proportion into electoral votes won (W_Electoral_Votes) and Total_Electoral_Votes
president_table <- 
  president_table %>% 
  tidyr::separate(
    col = "Electoral_Proportion", 
    into = c("W_Electoral_Votes", "Total_Electoral_Votes"), 
    sep = "/")

# convert those columns into integers
president_table <- president_table %>% readr::type_convert(col_types = cols(
  W_Electoral_Votes = col_integer(),
  Total_Electoral_Votes = col_integer()
))

# remove the electoral percentage column
president_table <- 
  president_table %>% 
    select(-Electoral_Percentage)

# take a look
president_table %>% select(Winner, W_Electoral_Votes, Total_Electoral_Votes) %>% head()
```

### Convert Voter Turnout Percentage to a Double
```{r voter_turnout}
# remove % sign and special characters
president_table <- 
  president_table %>% 
    tidyr::separate(col="Turnout_pct",
                    into = "Turnout_pct",
                    sep = "%",
                    remove = TRUE,
                    extra = "drop")

# convert voter turnout into a double and divide by 100
president_table$Turnout_pct <- president_table$Turnout_pct %>% as.double()
president_table <- president_table %>% mutate(Turnout_pct = Turnout_pct/100)
```

### Account for Losers Vote Count
Instead of having a column that displays the margin of the winners victory, we would like to rather have a column that displays how many votes the losing candidate recieved. But first, however, we need to convert the column of Winner_Votes into an integer. This involves cleaning (removing commas and other characters) from each row.
```{r loser_votes}
# First remove commas and random characters from Winner_Votes Column
president_table$Winner_Votes <- gsub("(\\W)","", president_table$Winner_Votes)

# Next, convert to integer
# president_table$Winner_Votes %>% as.integer()
```

# ABORT, DOUG ALREADY DID ABOVE :(
# This Document will be rewritten with Doug's Code to scrap a different source...
### Below is code to scrape population/census data.

### Scrape Population/Census Table
```{r scrape_census}
url <- 'https://en.wikipedia.org/wiki/Demographic_history_of_the_United_States#Historical_population'
xpath <- '//*[@id="mw-content-text"]/table[2]'

census <- read_html(url)

census_table <- census %>% html_node(xpath = xpath) %>% html_table()

# remove last row
census_table <- census_table[2:nrow(census_table),]

# pdf source: http://www2.census.gov/prod2/statcomp/documents/CT1970p2-13.pdf
```

### Stip commas from numbers
```{r strip_commas}
census_table$Population <- gsub(",","", census_table$Population)
```


Now lets write the table as an SQL entry file
```{r write_to_sql}
# Now let's write the census to a file as a sql command
fileConn <- "population.txt"
write("INSERT INTO `population` (`year`, `population`) VALUES ", fileConn)
for (k in 1:nrow(census_table)){
  if (k < nrow(census_table)) {
    write(sprintf("('%s', '%s'), ", census_table[k,1],census_table[k,2]), fileConn, append=TRUE)
  } else {
    write(sprintf("('%s', '%s')", census_table[k,1],census_table[k,2]), fileConn, append=TRUE)
  }
}
```


# Scraping Polling Data
### Original API sources for csv files.
We are getting our sources from [pollyvote.com](https://pollyvote.com/en/about/data/). Below is the list of URLs for API calls to get the csv for our data. Note that data for polls is only available from the 1940 election (that is when polling data became widely available and popular).
```{r}
# national expectation polls 2016
nep16 <- 'pollyvote.com/wp-content/plugins/pollyvote/data/index.php?time=current&type=expectations&format=csv' 

# national intention polls 2016
nip16 <- 'pollyvote.com/wp-content/plugins/pollyvote/data/index.php?time=current&type=polls&format=csv'

# national expectation polls historical (1940 - 2012)
neph <- 'pollyvote.com/wp-content/plugins/pollyvote/data/index.php?type=expectations&format=csv'

# national intention polls historical (1940 - 2012)
niph <- 'pollyvote.com/wp-content/plugins/pollyvote/data/index.php?type=polls&format=csv'
```

### Import/Download the csv from these URLs
```{r importCSV}
# filename: the name you want to download and save the csv as.
# df.name: the name of the dataframe for the csv you want
# source.URL: the url source that we download from
download_polls <- function(filename, df.name, source.URL) {
  if (!file.exists(filename)) {
    download.file(source.URL, destfile=filename)
  }
  assign(x = df.name, value = read_csv(filename), envir = .GlobalEnv)
}
```

**call the function above on all the polling data we want**
```{r}
# national expectation polls 2016
download_polls(filename = '2016_national_expectation_polls.csv', 
               df.name = 'national_expectation_polls.2016',
               source.URL = nep16)

# national intention polls 2016
download_polls(filename = '2016_national_intention_polls.csv', 
               df.name = 'national_intention_polls.2016',
               source.URL = nip16)

# national expectation polls historical (1940 - 2012)
download_polls(filename = 'historic_national_expectation_polls.csv', 
               df.name = 'national_expectation_polls.historic',
               source.URL = neph)

# national intention polls historical (1940 - 2012)
download_polls(filename = 'historic_national_intention_polls.csv', 
               df.name = 'national_intention_polls.historic',
               source.URL = niph)
```

### Only select the columns we care about
```{r selectGoodColumns}
# selects only relevant/good columns from the initial list of 43 columns that we get from the csv
selectGoodColumns <- function(df.name, list.of.columns) {
                              df.name %>% select(c(electionyear, 
                                                   fcdate,              # forecast date
                                                   daystoelection,      # the number of days until the election
                                                   fcrepvs,             # republican voter share
                                                   fcdemvs,             # democratic voter share
                                                   fcerror,             # forecase error (Forecast – Actual)
                                                   absolutefcerror,     # absolute forecast error
                                                   lastsurveyday,       # last day survey was conducted
                                                   firstsurveyday,      # first day survey was conducted
                                                   released,            # date survey was released
                                                   sample,              # sample size of survey
                                                   moe,                 # margin of error of survey
                                                   questiontxt,         # question text description of survey
                                                   surveyorg,           # survey organization
                                                   surveysponsor,       # survey sponsor
                                                   intmethod,           # interview method
                                                   sampledesc,          # information about the sample of respondents
                                                   state))
}

# national expectation polls 2016
national_expectation_polls.2016 <- selectGoodColumns(national_expectation_polls.2016)
national_expectation_polls.2016 <- national_expectation_polls.2016 %>% mutate(pollType = "expectation")

# national intention polls 2016
national_intention_polls.2016 <- selectGoodColumns(national_intention_polls.2016)
national_intention_polls.2016 <- national_intention_polls.2016 %>% mutate(pollType = "intention")

# national expectation polls historical (1940 - 2012)
national_expectation_polls.historic <- selectGoodColumns(national_expectation_polls.historic)
national_expectation_polls.historic <- national_expectation_polls.historic %>% mutate(pollType = "expectation")

# national intention polls historical (1940 - 2012)
national_intention_polls.historic <- selectGoodColumns(national_intention_polls.historic)
national_intention_polls.historic <- national_intention_polls.historic %>% mutate(pollType = "intention")
```

### Convert some columns before sql insertion
```{r }
# national expectation polls 2016
national_expectation_polls.2016 <- 
  national_expectation_polls.2016 %>% readr::type_convert(col_types = cols(
    fcdate = col_datetime(format="%d.%m.%Y"),
    lastsurveyday = col_datetime(format="%d.%m.%Y"),
    firstsurveyday = col_datetime(format="%d.%m.%Y"),
    released = col_datetime(format="%d.%m.%Y")
))

# national intention polls 2016
national_intention_polls.2016 <- 
  national_intention_polls.2016 %>% readr::type_convert(col_types = cols(
    fcdate = col_datetime(format="%d.%m.%Y"),
    lastsurveyday = col_datetime(format="%d.%m.%Y"),
    firstsurveyday = col_datetime(format="%d.%m.%Y"),
    released = col_datetime(format="%d.%m.%Y")
))

# national expectation polls historical (1940 - 2012)
national_expectation_polls.historic <- 
  national_expectation_polls.historic %>% readr::type_convert(col_types = cols(
    fcdate = col_datetime(format="%d.%m.%Y"),
    lastsurveyday = col_datetime(format="%d.%m.%Y"),
    firstsurveyday = col_datetime(format="%d.%m.%Y"),
    released = col_datetime(format="%d.%m.%Y")
))

# national intention polls historical (1940 - 2012)
national_intention_polls.historic <- 
  national_intention_polls.historic %>% readr::type_convert(col_types = cols(
    fcdate = col_datetime(format="%d.%m.%Y"),
    lastsurveyday = col_datetime(format="%d.%m.%Y"),
    firstsurveyday = col_datetime(format="%d.%m.%Y"),
    released = col_datetime(format="%d.%m.%Y")
))
```

## Build the SQL file
We will know loop through the four dataframes we have created convert the rows into mysql insert statements as well as define/create the relation for the table we will need (polls).
```{r sqlPolls}
pollsFile <- "polls.txt"
write("DROP TABLE IF EXISTS `polls`;", pollsFile)
write("CREATE TABLE presidential_elections.polls (election_year VARCHAR(64) NOT NULL, 
                                                  fc_date DATE, 
                                                  days_to_election DATE, 
                                                  fc_repvs FLOAT,
                                                  fc_demvs FLOAT,
                                                  fc_error FLOAT,
                                                  fc_absolute_error FLOAT,
                                                  last_survey_day DATE,
                                                  first_survey_day DATE,
                                                  release_day DATE,
                                                  sample INTEGER,
                                                  moe FLOAT,
                                                  question TEXT,
                                                  survey_org VARCHAR(64),
                                                  survey_sponser VARCHAR(128),
                                                  intmethod VARCHAR(30),
                                                  sample_desc TEXT,
                                                  state VARCHAR(40),
                                                  poll_type VARCHAR(15));", 
                                                  pollsFile,
                                                  append = TRUE)
write("INSERT INTO polls (                        election_year, 
                                                  fc_date, 
                                                  days_to_election, 
                                                  fc_repvs,
                                                  fc_demvs,
                                                  fc_error,
                                                  fc_absolute_error,
                                                  last_survey_day,
                                                  first_survey_day,
                                                  release_day,
                                                  sample,
                                                  moe,
                                                  question,
                                                  survey_org,
                                                  survey_sponser,
                                                  intmethod,
                                                  sample_desc,
                                                  state,
                                                  poll_type) VALUES ", pollsFile, append=TRUE)
```
### Write the values
```{r}
# function to write the tuples of each dataframe (df) to the polls.txt file
writeFD <- function(df) {
    for(i in 1:nrow(df)) {
      electionyear <-   df$electionyear
      fcdate <-         df$fcdate
      daystoelection <- df$daystoelection
      fcrepvs <-        df$fcrepvs
      fcdemvs <-        df$fcdemvs
      fcerror <-        df$fcerror
      absolutefcerror <-df$absolutefcerror
      lastsurveyday <-  df$lastsurveyday
      firstsurveyday <- df$firstsurveyday
      released <-       df$released
      sample <-         df$sample
      moe <-            df$moe
      questiontxt <-    gsub(x = df$questiontxt, pattern = "\'", replacement = "")
      surveyorg <-      gsub(x = df$surveyorg, pattern = "\'", replacement = "")
      surveysponsor <-  gsub(x = df$surveysponsor, pattern = "\'", replacement = "")
      intmethod <-      gsub(x = df$intmethod, pattern = "\'", replacement = "")
      sampledesc <-     gsub(x = df$sampledesc, pattern = "\'", replacement = "")
      state <-          df$state
      pollType <-       df$pollType
    
      # replace the NAs with NULL and sprintf into apporpriate format
      write(
      gsub(x = sprintf(
      "('%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s'),",
                    electionyear[i],
                    fcdate[i],
                    daystoelection[i],
                    fcrepvs[i],
                    fcdemvs[i],
                    fcerror[i],
                    absolutefcerror[i],
                    lastsurveyday[i],
                    firstsurveyday[i],
                    released[i],
                    sample[i],
                    moe[i],
                    questiontxt[i],
                    surveyorg[i],
                    surveysponsor[i],
                    intmethod[i],
                    sampledesc[i],
                    state[i],
                    pollType[i]),
      pattern="NA",
      replacement = "NULL"),
      pollsFile, append=TRUE)
    }
}

writeFD(national_expectation_polls.2016)
writeFD(national_intention_polls.2016)
writeFD(national_expectation_polls.historic)
writeFD(national_intention_polls.historic)
```
## Wola! We are done!
Just a note: at the end of the text file you should remove the last comma and replace it with a semicolon.
